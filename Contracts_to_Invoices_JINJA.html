<html lang="fa">
    <head>
        <title>گزارش صورت وضعیت های هر قرارداد</title>
        <style>
            table, td, th{
                border: 1px solid;
                border-collapse: collapse;
            }
            td, th {
                padding: 10px;
                text-align: center;
                font-size: 12px;
            }
        </style>
    </head>
    <body>

        {% set NO_DATA = "<span style='font-size:12;color:gray;'>اطلاعات ناموجود</span>" %}

        <table>

            <thead>
                <tr>
                    <th colspan="17">صورت وضعیت های هر قرارداد</th>
                </tr>

                <tr>
                    <th colspan="2">کلیات</th>

                    <th colspan="6">نوع صورت وضعیت</th> 

                    <th colspan="3">وضعیت</th>

                    <th colspan="2">تعداد</th> 

                    <th colspan="2">مبالغ</th> 
                </tr>

                <tr>

                    <th>شناسه</th>
                    <th>تعداد کل صورت وضعیت ها</th>

                    <th>صورت وضعیت کارکرد</th>
                    <th>صورت وضعیت تعدیل</th>
                    <th>صورت وضعیت مابه التفاوت نرخ ارز</th>
                    <th>صورت وضعیت فرزندآوری</th>
                    <th>صورت وضعیت پاداش</th>
                    <th>صورت وضعیت پیش پرداخت</th>

                    <th>خاتمه داده شده</th>
                    <th>فسخ شده</th>
                    <th>تکمیل شده</th>

                    <th>تعداد صورت وضعیت قطعی</th>
                    <th>تعداد فاکتورها</th>
                    
                    <th>مبلغ تجمعی پیمانکار</th> 
                    <th>ناخالص دوره کارکرد</th> 
                   
                </tr>
            </thead>

            <tbody>
    
                
                <tr>
                    <td>{{INVS}}</td>
                    <td>{{INVS | length}}</td>

                    <td>{{INVS | selectattr("TYPE", "equalto", [0]) | list | length }}</td>
                    <td>{{INVS | selectattr("TYPE", "equalto", [1]) | list | length }}</td>
                    <td>{{INVS | selectattr("TYPE", "equalto", [2]) | list | length }}</td>
                    <td>{{INVS | selectattr("TYPE", "equalto", [3]) | list | length }}</td>
                    <td>{{INVS | selectattr("TYPE", "equalto", [4]) | list | length }}</td>
                    <td>{{INVS | selectattr("TYPE", "equalto", [5]) | list | length }}</td>

                    <td>{{INVS | selectattr("STATUS", "equalto", [0]) | list | length }}</td>
                    <td>{{INVS | selectattr("STATUS", "equalto", [1]) | list | length }}</td>
                    <td>{{INVS | selectattr("STATUS", "equalto", [2]) | list | length }}</td>

                    <td>{{INVS | selectattr("FINAL", "equalto", 1) | list | length }}</td>
                    <td>{{INVS | selectattr("FACTOR") | list | length }}</td>               

                    <!-- there are some FUNC_IMPURE values or SUM_IMPURE values that are equal to [] which causes error here -->
                    <!-- <td>{{INVS | map(attribute='FUNC_IMPURE') | map(attribute=0) | map(attribute='amount') | sum }}</td>
                    <td>{{INVS | map(attribute='SUM_IMPURE') | map(attribute=0) | map(attribute='amount') | sum }}</td>-->
                    
                    {% set func_amounts = INVS
                        | selectattr('FUNC_IMPURE','defined')
                        | map(attribute='FUNC_IMPURE')
                        | selectattr('0', 'defined')
                        | map(attribute=0)
                        | selectattr('amount', 'defined')
                        | map(attribute='amount') %}
                    
                    <td>{{ func_amounts | sum }}</td>
                    
                    {% set sum_amounts = INVS
                        | selectattr('SUM_IMPURE', 'defined')
                        | map(attribute='SUM_IMPURE')
                        | selectattr('0', 'defined')
                        | map(attribute=0)
                        | selectattr('amount', 'defined')
                        | map(attribute='amount') %}
                    
                    <td>{{ sum_amounts | sum }}</td>
                    
    
                </tr>
            </tbody>

        </table>
    </body>
</html>